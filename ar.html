<html>
    <header>
	    <meta name="apple-mobile-web-app-capable" content="yes">
        <script src="https://aframe.io/releases/0.9.2/aframe.min.js"></script>
		<!-- we import arjs version without NFT but with marker + location based support -->
		<script src="https://cdn.rawgit.com/jeromeetienne/AR.js/1.6.0/aframe/build/aframe-ar.js"></script>
		<script src="https://raw.githack.com/fcor/arjs-gestures/master/dist/gestures.js"></script>
		<script src="https://rawgit.com/donmccurdy/aframe-extras/master/dist/aframe-extras.loaders.min.js"></script>
		<link href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/css/bootstrap.min.css" rel="stylesheet">
		<link href="https://cdnjs.cloudflare.com/ajax/libs/magnific-popup.js/1.0.0/magnific-popup.min.css" rel="stylesheet">
		<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"></script>
		<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/js/bootstrap.min.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/magnific-popup.js/1.0.0/jquery.magnific-popup.min.js"></script>
		<link href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.8/themes/base/jquery-ui.css" rel="stylesheet" type="text/css">
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.4/jquery.min.js" type="text/javascript"></script>
        <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.8/jquery-ui.min.js" type="text/javascript"></script>
		<!-- <script src="scripts/clickhandler.js" type="text/javascript"></script> -->

		<script>
		  	// $(document).ready(function() {
            //     $.ajax({
            //         type: "Get",
            //         url: "database.json",
            //         dataType: "json",
            //         success: function(response) {
			// 			const marker = response.markerurl;
			// 			const model = response.modelurl;
			// 			const video = response.videourl;

			// 			if(video){
			// 			  $("#promotional").html('<source src="'+ video +'" type="video/mp4"></source>' );
			// 			}
			
			// 			// var modelElement = document.createElement("a-asset-item");
			// 			// $(modelElement).attr({
			// 			// 	id:"scene1",
			// 			// 	src: model
			// 			// });

			// 			$("a-assets").append(modelElement);

			// 			var markerElement = document.createElement("a-marker");
			// 			$(markerElement).attr({
			// 				type:"pattern", 
			// 				preset:"custom", 
			// 				url:marker,
			// 				raycaster:"objects: #helmet-model3; near: 0; far:50000;",
			// 				emitevents:"true",
			// 				cursor:"fuse: false; rayOrigin: mouse;",
			// 				smooth:"true", 
			// 				smoothCount:"20" ,
			// 				smoothTolerance:"1.8",
			// 				smoothThreshold:"9"
			// 			});
			// 			$("a-scene").append(markerElement);

			// 			var textElement = document.createElement("a-text");
			// 			$(textElement).attr({
			// 				value:"Tap on 3D model to play video", 
		  	// 				rotation:"268 0 0" ,
		  	// 				position:"0.5 0 -5"
			// 			});
			// 			$(markerElement).append(textElement);

			// 			var videoElement = document.createElement("a-video");
			// 			$(videoElement).attr({
			// 				id:"videoPlayer",
			// 				src: "#promotional",
			// 				type:"video/mp4", 
			// 				width:"5.2", 
			// 				height:"3", 
			// 				rotation:"268 0 0", 
			// 				position:"0 0 2.5"
			// 			});
			// 			$(markerElement).append(videoElement);

			// 			var modelElement = document.createElement("a-entity");
			// 			$(modelElement).attr({
			// 				id:"bottle-model",
			// 				position:"0 -2 0",
			// 				scale:"0.07 0.07 0.07",
			// 			});
			// 			modelElement.setAttribute('gltf-model', model);
			// 			modelElement.setAttribute('gesture-handler', "minScale: 1; maxScale: 1.5");
			// 			modelElement.setAttribute('clickhandler', "modelId: #bottle-model; videoId: #promotional");

			// 			$(markerElement).append(modelElement);
            //         },
            //         error: function(){
            //             alert("json not found");
            //         }
            //     });
            // });
		</script>
		
    </header>
	

    <body style="margin : 0px; overflow: hidden;">	 
      <a-scene 
        arjs = "sourceType: webcam; sourceWidth:1280; sourceHeight:960; displayWidth: 1280; displayHeight: 960; trackingMethod: best; debugUIEnabled: false;"
	    embedded 
		renderer="logarithmicDepthBuffer: true; antialias: true; colorManagement: true;"
		vr-mode-ui="enabled: false"
		id="scene"
		gesture-detector
		loading-screen="dotsColor: #515F8F; backgroundColor: #C1C9E1"
	  >
	  <a-assets id="assets">
	    <a-asset-item
		  id="scene1"
		  src="https://auth-service-dev-serverlessdeploymentbucket-6mwsvzoosc9r.s3.amazonaws.com/winbot/untitled.gltf"
		>
		<!-- <a-asset-item
		  id="bottle-obj"
		  src="https://auth-service-dev-serverlessdeploymentbucket-6mwsvzoosc9r.s3.amazonaws.com/bottle/Final+bot.obj"
		>
        <a-asset-item
		  id="bottle-mtl"
		  src="https://auth-service-dev-serverlessdeploymentbucket-6mwsvzoosc9r.s3.amazonaws.com/bottle/Final+bot.mtl"
		> -->
		<video crossorigin="anonymous" id="promotional" src=video.mp4 type="video/mp4" loop="false" preload="auto"  playsinline>
	  </a-assets>
	  <a-marker
		type="pattern" 
		preset="custom" 
		url="pattern-marker.patt"
		raycaster="objects: #helmet-model3; near: 0; far:50000;"
		emitevents="true"
		cursor="fuse: false; rayOrigin: mouse;"
		smooth="true" 
		smoothCount="20" 
		smoothTolerance="1.8" 
		smoothThreshold="9" 
	  >
	    <a-text 
		  value="Tap on 3D model to play video1" 
		  rotation="268 0 0" 
		  position="0.5 0 -5" 
		></a-text>
		  <!-- <a-plane id="videoPlayer" material="src:#promotional" height="5" width="10" rotation="-90 0 0" position="0 0 4"></a-plane> -->
	    <!-- <a-video id="videoPlayer" src="#promotional" width="5.2" height="3" rotation="268 0 0" position="0 0 2.5"></a-video> -->
		<a-entity
		  refraction-shader
		  clickhandler
		  id="helmet-model3"
		  gltf-model="#scene1"
		  position="0 0 0"
		  scale="0.9 0.9 0.9"
		  gesture-handler="minScale: 1; maxScale: 1.5"
        >
		<a-torus id="clearTorus" refraction-shader position="2 2 2" scale="1 1 1"></a-torus>
		<!-- <a-entity
		  id="helmet-model3"
		  obj-model="obj: #bottle-obj; mtl: #bottle-mtl"
          scale="0.01 0.01 0.01"
		  rotation="268 0 0"
          gesture-handler
        > -->
		</a-entity>
      </a-marker>
	  <a-entity camera></a-entity>
    </a-scene>
	
	<script>
		AFRAME.registerComponent('clickhandler', {
			init: function() {
				const btn = document.querySelector("#helmet-model3");
				var v = document.querySelector("#promotional")
				btn.addEventListener('click', () => {
					v.play();
				});		
		}});

		AFRAME.registerComponent('refraction-shader', {
			init: function () {
			this.prepare = this.prepare.bind(this)
			var timerId = setInterval( e => {
				if (!this.el.sceneEl.systems.arjs['_arSession'])
				return;
				clearInterval(timerId)
				this.prepare()
			}, 1000)
			},
			prepare: function() {
			
				const data = this.data;
				/**** SHADER DEFINITIONS *****/
				const vertexShader = `
				varying vec3 vRefract;
				uniform float refractionRatio;

				void main() {
					vec4 mPosition = modelMatrix * vec4( position, 1.0 );
					vec3 nWorld = normalize( mat3( modelMatrix[0].xyz, modelMatrix[1].xyz, modelMatrix[2].xyz ) * normal );
					vRefract = normalize( refract( normalize( mPosition.xyz - cameraPosition ), nWorld, refractionRatio ) );

					gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );
				}`

				const fragShader = `uniform sampler2D texture;
				varying vec3 vRefract;
				// experiment with distance to the video plane. should do real ray-plane-intersection!
				uniform float distance;

				void main(void) {
					vec2 p = vec2(vRefract.x*distance + 0.5, vRefract.y*distance + 0.5);

					vec3 color = texture2D( texture, p ).rgb;
					gl_FragColor = vec4( color, 1.0 );
				}`
				
				
				// use the video element to create a video texture     
				var texture = new THREE.VideoTexture(this.el.sceneEl.systems.arjs['_arSession'].arSource.domElement)
				texture.minFilter =  THREE.NearestFilter
			

				this.material  = new THREE.ShaderMaterial({
					uniforms: {
						time: { value: 0.0 },
						texture: { type: 't', value: texture },
						// pull to see the throshold: 0.7-ish solid glass/water ("upsidevdown"), 0.8+ thinner glass ("magnifying glass")
						refractionRatio: { type: 'f', value: 0.9 },
						// experiment to adjust offset to video-plane. set to 1 for no effect
						distance: { type: 'f', value: 1 }
					},
					// Note, idk why exactly, but it appears that you NEED to explicitly
					// name the vertexShader & fragmentShader arguments and not just as:
					// vertexShader,
					// fragShader
					//
					// Will expore this some other time ¯\_(ツ)_/¯
					vertexShader : vertexShader,
					fragmentShader : fragShader
				});
				this.material.uniforms.texture.value.wrapS = this.material.uniforms.texture.value.wrapT = THREE.ClampToEdgeWrapping;
				this.applyToMesh();
				this.el.addEventListener('model-loaded', () => this.applyToMesh());
				this.ready = true
			},
			/**
			 * Apply the material to the current entity.
			 */
			applyToMesh: function() {
				const mesh = this.el.getObject3D('mesh');
				if (mesh) {
					mesh.material = this.material;
				}
			},
			/**
			 * On each frame, update the 'time' uniform in the shaders.
			 */
			tick: function (t) {
			if (this.ready) {
				this.material.uniforms.time.value = t / 1000;
			}
			}
		})

	</script>
	
    </body>
</html>


